<div class="mt-4">
    <div class="container" style="margin-top: 50px;">
        <h1>Quản Lý Khóa Học</h1>
        
        <table class="table table-hover">
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#courseModal">
                    Thêm khóa học
                </button>
            </div>
            <thead>
                <tr class="text-center">
                    <th scope="col">#</th>
                    <th scope="col">Name</th>
                    <th scope="col">Description</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody>
                {{#each courses}}
                    <tr class="text-center">
                        <th scope="row">{{inc @index}}</th>
                        <td class="text-truncate" style="max-width: 100px;">{{name}}</td>
                        <td class="text-truncate" style="max-width: 150px;">{{description}}</td>
                        <td>
                            <button class="btn btn-outline-info btn-update" 
                                    data-id="{{_id}}" 
                                    data-name="{{name}}" 
                                    data-description="{{description}}" 
                                    data-img="{{img_courses}}"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#updateModal">
                                Update
                            </button>
                            <button class="btn btn-outline-danger btn-delete" 
                                    data-id="{{_id}}" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deleteModal">
                                Delete
                            </button>
                        </td>
                    </tr>
                {{else}}
                    <tr>
                        <td colspan="4" class="text-center">Không có khóa học nào.
                            <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#courseModal">Thêm khóa học</a>
                        </td>
                    </tr>
                {{/each}}


            </tbody>
        </table>

        <div class="modal fade" id="courseModal" tabindex="-1" aria-labelledby="courseModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered"> 
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="courseModalLabel">Tạo Khóa Học</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="/course/add" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="name" class="form-label">Course Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>

                    <input type="text" class="form-control" name="slug" id="slug" hidden>

                    <div class="mb-3">
                        <label for="description" class="form-label">Course Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="img_courses" class="form-label">Course Image</label>
                        <input class="form-control" type="file" name="img_courses" id="img" required>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Tạo khóa học</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                    </form>
                </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                <form method="POST" id="update-form" enctype="multipart/form-data">
                    <div class="modal-header">
                    <h5 class="modal-title" id="updateModalLabel">Cập Nhật Khóa Học</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>
                    <div class="modal-body">

                    <input type="hidden" name="id" id="update-id">

                    <div class="mb-3">
                        <label class="form-label">Tên khóa học</label>
                        <input type="text" class="form-control" name="name" id="update-name" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" name="description" id="update-description" rows="3" required></textarea>
                    </div>
                    
                    <div class="row d-flex justify-content-center align-items-center">
                        <div class="col">
                            <div class="mb-3">
                                <label class="form-label">Ảnh hiện tại</label><br>
                                <img id="update-img-preview" src="" alt="Ảnh hiện tại" style="max-width: 150px;">
                            </div>
                        </div>
                        <div class="col">
                            =>
                        </div>

                        <div class="col-8">
                            <div class="mb-3">
                                <label class="form-label">Ảnh mới (nếu muốn thay đổi)</label>
                                <input type="file" class="form-control" name="img_courses">
                            </div>
                        </div>
                    </div>

                    </div>
                    <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Cập Nhật</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                <form id="delete-form" method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModalLabel">Xác nhận xoá</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>

                    <div class="modal-body">
                        <input type="hidden" name="id" id="delete-id">
                        Bạn có chắc chắn muốn xoá khóa học <strong id="delete-name"></strong>?
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger">Xoá</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                    </div>
                </form>
                </div>
            </div>
        </div>

        <script>
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');

            if (success === 'created') {
                Swal.fire({
                icon: 'success',
                title: 'Đã thêm khóa học!',
                showConfirmButton: false,
                timer: 2000
                });
                window.history.replaceState(null, '', '/course/management');
            }

            if (success === 'updated') {
                Swal.fire({
                icon: 'success',
                title: 'Cập nhật thành công!',
                showConfirmButton: false,
                timer: 2000
                });
                window.history.replaceState(null, '', '/course/management');
            }

            if (success === 'deleted') {
                Swal.fire({
                icon: 'success',
                title: 'Đã xoá khóa học!',
                showConfirmButton: false,
                timer: 2000
                });
                window.history.replaceState(null, '', '/course/management');
            }

            const nameInput = document.getElementById('name');
            const slugInput = document.getElementById('slug');

            nameInput.addEventListener('input', function () {
                slugInput.value = nameInput.value;
            });

            // Update modal functionality
            const updateButtons = document.querySelectorAll('.btn-update');

            updateButtons.forEach(button => {
                button.addEventListener('click', () => {
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');
                const description = button.getAttribute('data-description');
                const img = button.getAttribute('data-img');

                document.getElementById('update-id').value = id;
                document.getElementById('update-name').value = name;
                document.getElementById('update-description').value = description;
                document.getElementById('update-img-preview').src = img;

                document.getElementById('update-form').action = '/course/update/' + id;
                });
            });

            // Nút xoá
            const deleteButtons = document.querySelectorAll('.btn-delete');

            deleteButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.getAttribute('data-id');

                    document.getElementById('delete-form').action = '/course/delete/' + id;

                    // Nếu bạn có hiển thị tên khóa học trong modal:
                    const name = button.closest('tr').querySelector('td:nth-child(2)').innerText;
                    document.getElementById('delete-name').textContent = name;
                });
            });

        </script>
    </div>
</div>