<!DOCTYPE html> 
<html lang="en">
   <head>
      {{> headAD }}
   </head>
   <!--end::Head-->
   <!--begin::Body--> 
   <body id="kt_app_body" data-kt-app-header-fixed="true" data-kt-app-header-fixed-mobile="true"
      data-kt-app-sidebar-enabled="true" data-kt-app-sidebar-fixed="true" data-kt-app-sidebar-hoverable="true"
      data-kt-app-sidebar-push-header="true" data-kt-app-sidebar-push-toolbar="true"
      data-kt-app-sidebar-push-footer="true" class="app-default">
      <!--begin::Theme mode setup on page load-->
      <!--end::Theme mode setup on page load-->
      <!--begin::App-->
      <div class="d-flex flex-column flex-root app-root" id="kt_app_root">
         <!--begin::Page-->
         <div class="app-page  flex-column flex-column-fluid " id="kt_app_page">
            <!--begin::Header-->
            <div id="kt_app_header" class="app-header ">
               <!--begin::Header container-->
               <div class="app-container  container-fluid d-flex align-items-stretch flex-stack "
                  id="kt_app_header_container">
                  <!--begin::Sidebar toggle-->
                  <div class="d-flex align-items-center d-block d-lg-none ms-n3" title="Show sidebar menu">
                     <div class="btn btn-icon btn-active-color-primary w-35px h-35px me-2"
                        id="kt_app_sidebar_mobile_toggle">
                        <i class="ki-outline ki-abstract-14 fs-2">
                        </i>
                     </div>
                     <!--begin::Logo image-->
                     <a href="https://preview.keenthemes.com/metronic8/demo38/index.html">
                     <img alt="Logo" src="https://preview.keenthemes.com/metronic8/demo38/assets/media/logos/demo38-small.svg"
                        class="h-30px" />
                     </a>
                     <!--end::Logo image-->
                  </div>
                  <!--end::Sidebar toggle-->
                  <!--begin::Navbar-->
                  {{> navbarAD }}
                  <!--end::Navbar-->
                  <!--begin::Separator-->
                  <div class="app-navbar-separator separator d-none d-lg-flex">
                  </div>
                  <!--end::Separator-->
               </div>
               <!--end::Header container-->
            </div>
            <!--end::Header-->
            <!--begin::Wrapper-->
            <div class="app-wrapper  flex-column flex-row-fluid " id="kt_app_wrapper">
               <!--begin::Sidebar-->
               {{> sidebarAD }}
               <!--end::Sidebar-->
               <!--begin::Main-->
               <div class="app-main flex-column flex-row-fluid " id="kt_app_main">
                  <!--begin::Content wrapper-->
                  <div class="d-flex flex-column flex-column-fluid">
                     <!--begin::Content-->
                     <div id="kt_app_content" class="app-content  flex-column-fluid ">
                        <!--begin::Content container-->
                        <div id="kt_app_content_container" class="app-container container-fluid">


                           <h1>Trang quản lý người dùng</h1>
                           <div id="kt_app_content" class="app-content  flex-column-fluid " bis_skin_checked="1" data-select2-id="select2-data-kt_app_content">
                              <!--begin::Content container-->
                              <div id="kt_app_content_container" class="app-container  container-fluid " bis_skin_checked="1" data-select2-id="select2-data-kt_app_content_container">
                                 <!--begin::Products-->
                                 <div class="card card-flush" bis_skin_checked="1" data-select2-id="select2-data-134-e5aw">
                                    <!--begin::Card header-->
                                    <div class="card-header align-items-center py-5 gap-2 gap-md-5" bis_skin_checked="1" data-select2-id="select2-data-133-vrpy">
                                       <!--begin::Card title-->
                                       <div class="card-title" bis_skin_checked="1">
                                          <!--begin::Search-->
                                          <div class="d-flex align-items-center position-relative my-1" bis_skin_checked="1">
                                             <i class="ki-outline ki-magnifier fs-3 position-absolute ms-4"></i>                <input type="text" data-kt-ecommerce-product-filter="search" class="form-control form-control-solid w-250px ps-12" placeholder="Search Product">
                                          </div>
                                          <!--end::Search-->
                                       </div>
                                       <!--end::Card title-->
                                       <!--begin::Card toolbar-->
                                       <div class="card-toolbar flex-row-fluid justify-content-end gap-5" bis_skin_checked="1" data-select2-id="select2-data-132-kewa">
                                          <div class="w-100 mw-150px" bis_skin_checked="1" data-select2-id="select2-data-131-9u34">
                                             <!--begin::Select2-->
                                             <select class="form-select form-select-solid select2-hidden-accessible" data-control="select2" data-hide-search="true" data-placeholder="Status" data-kt-ecommerce-product-filter="status" data-select2-id="select2-data-7-og92" tabindex="-1" aria-hidden="true" data-kt-initialized="1">
                                                <option data-select2-id="select2-data-9-gdby"></option>
                                                <option value="all" data-select2-id="select2-data-136-ci2d">All</option>
                                                <option value="published" data-select2-id="select2-data-137-w3hn">Published</option>
                                                <option value="scheduled" data-select2-id="select2-data-138-px4r">Scheduled</option>
                                                <option value="inactive" data-select2-id="select2-data-139-xe66">Inactive</option>
                                             </select>
                                             <span class="select2 select2-container select2-container--bootstrap5 select2-container--below" dir="ltr" data-select2-id="select2-data-8-ec9q" style="width: 100%;"><span class="selection"><span class="select2-selection select2-selection--single form-select form-select-solid" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-disabled="false" aria-labelledby="select2-y6tt-container" aria-controls="select2-y6tt-container"><span class="select2-selection__rendered" id="select2-y6tt-container" role="textbox" aria-readonly="true" title="Status"><span class="select2-selection__placeholder">Status</span></span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span></span></span><span class="dropdown-wrapper" aria-hidden="true"></span></span>
                                             <!--end::Select2-->
                                          </div>
                                          <!--begin::Add product-->
                                          <a href="" class="btn btn-primary">
                                          Add Product
                                          </a>
                                          <!--end::Add product-->
                                       </div>
                                       <!--end::Card toolbar-->
                                    </div>
                                    <!--end::Card header-->
                                    <!--begin::Card body-->
                                    <div class="card-body pt-0" bis_skin_checked="1">
                                       <!--begin::Table-->
                                       <div id="kt_ecommerce_products_table_wrapper" class="dt-container dt-bootstrap5 dt-empty-footer" bis_skin_checked="1"> 
                                          <div id="" class="table-responsive" bis_skin_checked="1">
                                             <table class="table align-middle table-row-dashed fs-6 gy-5 dataTable" id="kt_ecommerce_products_table" style="width: 100%;">
                                                <colgroup>
                                                    <col data-dt-column="0" style="width: 36.3906px;">
                                                    <col data-dt-column="1" style="width: 200px;">     <!-- Avatar + Tên + Email -->
                                                    <col data-dt-column="2" style="width: 100px;">     <!-- Provider -->
                                                    <col data-dt-column="3" style="width: 100px;">     <!-- Vai trò -->
                                                    <col data-dt-column="4" style="width: 90px;">      <!-- Level --> 
                                                    <col data-dt-column="5" style="width: 100px;">     <!-- Số dư -->
                                                    <col data-dt-column="6" style="width: 105.156px;"> <!-- Trạng thái -->
                                                    <col data-dt-column="7" style="width: 100px;">     <!-- Hành động -->
                                                </colgroup>
                                                <thead>
                                                    <tr class="text-center text-gray-500 fw-bold fs-7 text-uppercase gs-0">
                                                        <th class="w-10px pe-2 dt-orderable-none">
                                                            <div class="form-check form-check-sm form-check-custom form-check-solid me-3">
                                                                <input class="form-check-input" type="checkbox" data-kt-check="true" data-kt-check-target="#kt_ecommerce_products_table .form-check-input" value="1">
                                                            </div>
                                                        </th>
                                                        <th class="min-w-200px dt-orderable-asc dt-orderable-desc text-center" data-dt-column="1" tabindex="0">
                                                            <span class="dt-column-title" role="button">User</span>
                                                            <span class="dt-column-order"></span>
                                                        </th>
                                                        <th class="min-w-100px dt-type-numeric dt-orderable-asc dt-orderable-desc text-center" data-dt-column="3" tabindex="0">
                                                            <span class="dt-column-title" role="button">Email</span>
                                                            <span class="dt-column-order"></span>
                                                        </th>
                                                        <th class="min-w-100px dt-type-numeric dt-orderable-asc dt-orderable-desc text-center" data-dt-column="2" tabindex="0">
                                                            <span class="dt-column-title" role="button">Gender</span>
                                                            <span class="dt-column-order"></span>
                                                        </th>
                                                        <th class="min-w-70px dt-type-numeric dt-orderable-asc dt-orderable-desc text-center" data-dt-column="4" tabindex="0">
                                                            <span class="dt-column-title" role="button">Level</span>
                                                            <span class="dt-column-order"></span>
                                                        </th> 
                                                        <th class="min-w-100px dt-type-numeric dt-orderable-asc dt-orderable-desc text-center" data-dt-column="6" tabindex="0">
                                                            <span class="dt-column-title" role="button">Balance</span>
                                                            <span class="dt-column-order"></span>
                                                        </th>
                                                        <th class="min-w-100px dt-orderable-asc dt-orderable-desc text-center" data-dt-column="7" tabindex="0">
                                                            <span class="dt-column-title" role="button">Status</span>
                                                            <span class="dt-column-order"></span>
                                                        </th>
                                                        <th class="min-w-70px dt-orderable-none text-center" data-dt-column="8">
                                                            <span class="dt-column-title">Actions</span>
                                                            <span class="dt-column-order"></span>
                                                        </th>
                                                    </tr>
                                                </thead>
                                                
                                                <tbody class="fw-semibold text-gray-600 text-center">
                                                    {{#each users}}
                                                        <tr>
                                                        <td>
                                                            <div class="form-check form-check-sm form-check-custom form-check-solid">
                                                            <input class="form-check-input" type="checkbox" value="{{_id}}">
                                                            </div>
                                                        </td>

                                                        <td>
                                                            <div class="d-flex align-items-center justify-content-center">
                                                            <a href="#" class="symbol symbol-50px">
                                                                <span class="symbol-label" style="background-image:url('{{avatarUrl}}');"></span>
                                                            </a>
                                                            <div class="ms-5">
                                                                <span class="text-gray-800 fs-5 fw-bold">{{name}}</span>
                                                            </div>
                                                            </div>
                                                        </td>

                                                        <td><span class="badge badge-info">{{email}}</span></td> 
                                                        <td>
                                                            {{#if (eq gender "male")}}
                                                                <span class="badge badge-primary">Male</span>
                                                            {{else if (eq gender "female")}}
                                                                <span class="badge badge-danger">Female</span>
                                                            {{else}}
                                                                <span class="badge badge-secondary">Other</span>
                                                            {{/if}}
                                                        </td>
                                                        
                                                        <td>
                                                            {{#if (eq level 1)}}
                                                                <span class="text-muted" title="Mặc định">
                                                                    <i class="fa-solid fa-user fa-xl" style="color: #6c757d;"></i>
                                                                    <span class="ms-1">Mặc định</span>
                                                                </span>
                                                            {{else if (eq level 2)}}
                                                                <span class="text-bronze" title="Rank Đồng">
                                                                    <i class="fa-solid fa-medal fa-xl" style="color: #cd7f32;"></i>
                                                                    <span class="ms-1">Rank Đồng</span>
                                                                </span>
                                                            {{else if (eq level 3)}}
                                                                <span class="text-silver" title="Rank Bạc">
                                                                    <i class="fa-solid fa-award fa-xl" style="color: #c0c0c0;"></i>
                                                                    <span class="ms-1">Rank Bạc</span>
                                                                </span>
                                                            {{else if (eq level 4)}}
                                                                <span class="text-gold" title="Rank Vàng">
                                                                    <i class="fa-solid fa-trophy fa-xl" style="color: #ffd700;"></i>
                                                                    <span class="ms-1">Rank Vàng</span>
                                                                </span>
                                                            {{else if (eq level 5)}}
                                                                <span class="text-warning" title="Khách VIP">
                                                                    <i class="fa-solid fa-crown fa-xl" style="color: #f4c430;"></i>
                                                                    <span class="ms-1">Khách VIP</span>
                                                                </span>
                                                            {{/if}}
                                                        </td>

                                                        <td>{{currentMoney}}</td>

                                                        <td>
                                                            {{#if isBanned}}
                                                            <div class="badge badge-light-danger">Banned</div>
                                                            {{else}}
                                                            <div class="badge badge-light-success">Active</div>
                                                            {{/if}}
                                                        </td>

                                                        <td>
                                                            <a href="#" class="btn btn-sm btn-light btn-flex btn-center btn-active-light-primary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
                                                            Actions <i class="ki-outline ki-down fs-5 ms-1"></i>
                                                            </a>
                                                            <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4" data-kt-menu="true">
                                                            <div class="menu-item px-3">
                                                                <a href="#" class="menu-link px-3 btn-show-user" data-user-id="{{_id}}">Show</a>
                                                            </div>
                                                            {{#if isBanned}}
                                                                <div class="menu-item px-3"><a href="/admin/userM/unban/{{_id}}" class="menu-link px-3">Unban</a></div>
                                                            {{else}}
                                                                <div class="menu-item px-3"><a href="/admin/userM/ban/{{_id}}" class="menu-link px-3">Ban</a></div>
                                                            {{/if}}
                                                            </div>
                                                        </td>
                                                        </tr>
                                                    {{/each}} 
                                                </tbody>
                                             </table>
                                          </div>

                                          <div class="row">
                                            <!-- Dropdown chọn số lượng bản ghi -->
                                            <div class="col-sm-12 col-md-5 d-flex align-items-center justify-content-center justify-content-md-start dt-toolbar">
                                                <div>
                                                <select name="kt_ecommerce_products_table_length" aria-controls="kt_ecommerce_products_table" class="form-select form-select-solid form-select-sm" id="dt-length-0">
                                                    <option value="10">10</option>
                                                    <option value="25">25</option>
                                                    <option value="50">50</option>
                                                    <option value="100">100</option>
                                                </select>
                                                </div>
                                            </div>

                                            <!-- Phân trang -->
                                            <div class="col-sm-12 col-md-7 d-flex align-items-center justify-content-center justify-content-md-end">
                                                <div class="dt-paging paging_simple_numbers">
                                                <nav aria-label="pagination">
                                                    <ul class="pagination">
                                                    <!-- JavaScript sẽ tự sinh nút phân trang tại đây -->
                                                    </ul>
                                                </nav>
                                                </div>
                                            </div>
                                        </div>

                                       </div>
                                       <!--end::Table--> 

                                        <!-- Modal -->
                                        <div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                                <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title d-flex align-items-center gap-3">
                                                        Thông tin người dùng
                                                        <span id="modalStatus" class="badge align-middle"></span>
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                                                </div>

                                                <div class="modal-body">
                                                    <div class="row g-4">
                                                        <!-- Avatar -->
                                                        <div class="col-12 text-center">
                                                            <img id="modalAvatar" src="" alt="Avatar" class="rounded-circle" width="100" height="100">
                                                        </div>

                                                        <!-- Name -->
                                                        <div class="col-md-6">
                                                            <label class="form-label">Họ tên</label>
                                                            <input type="text" id="modalName" class="form-control" readonly>
                                                        </div>

                                                        <!-- Username -->
                                                        <div class="col-md-6">
                                                            <label class="form-label">Tên người dùng</label>
                                                            <input type="text" id="modalUsername" class="form-control" readonly>
                                                        </div>

                                                        <!-- Email -->
                                                        <div class="col-md-6">
                                                            <label class="form-label">Email</label>
                                                            <input type="text" id="modalEmail" class="form-control" readonly>
                                                        </div>

                                                        <!-- Giới tính -->
                                                        <div class="col-md-6">
                                                            <label class="form-label">Giới tính</label>
                                                            <input type="text" id="modalGender" class="form-control" readonly>
                                                        </div>

                                                        <!-- Level -->
                                                        <div class="col-md-4">
                                                            <label class="form-label">Cấp bậc (Level)</label>
                                                            <input type="text" id="modalLevel" class="form-control" readonly>
                                                        </div>

                                                        <!-- Role -->
                                                        <div class="col-md-4">
                                                            <label class="form-label">Vai trò (Role)</label>
                                                            <input type="text" id="modalRole" class="form-control" readonly>
                                                        </div>

                                                        <!-- Provider -->
                                                        <div class="col-md-4">
                                                            <label class="form-label">Provider</label>
                                                            <input type="text" id="modalProvider" class="form-control" readonly>
                                                        </div>

                                                        <!-- Tổng nạp -->
                                                        <div class="col-md-6">
                                                            <label class="form-label">Tổng đã nạp</label>
                                                            <input type="text" id="modalDeposit" class="form-control" readonly>
                                                        </div>

                                                        <!-- Số dư hiện tại -->
                                                        <div class="col-md-6">
                                                            <label class="form-label">Tiền hiện có</label>
                                                            <input type="text" id="modalMoney" class="form-control" readonly>
                                                        </div>

                                                        <!-- Token -->
                                                        <div class="col-md-12">
                                                            <label class="form-label">Token</label>
                                                            <textarea id="modalToken" class="form-control" rows="2" readonly></textarea>
                                                        </div> 
                                                    </div>
                                                </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <script>
                                            document.addEventListener("DOMContentLoaded", () => {
                                                const showButtons = document.querySelectorAll(".btn-show-user");
                                                const headers = document.querySelectorAll("thead th[data-dt-column]");

                                                showButtons.forEach((btn) => {
                                                    btn.addEventListener("click", async (e) => {
                                                        e.preventDefault();
                                                        const userId = btn.dataset.userId;

                                                        try {
                                                        const res = await fetch(`/admin/userM/show/${userId}`);
                                                        const { data } = await res.json();

                                                        document.getElementById("modalName").value = data.name;
                                                        document.getElementById("modalUsername").value = data.username;
                                                        document.getElementById("modalEmail").value = data.email;
                                                        document.getElementById("modalGender").value = data.gender;
                                                        document.getElementById("modalLevel").value = data.level;
                                                        document.getElementById("modalRole").value = data.role;
                                                        document.getElementById("modalProvider").value = data.provider;
                                                        document.getElementById("modalDeposit").value = data.totalDeposit;
                                                        document.getElementById("modalMoney").value = data.currentMoney;
                                                        document.getElementById("modalToken").value = data.token;
                                                        document.getElementById("modalAvatar").src = data.avatarUrl;

                                                        const statusEl = document.getElementById("modalStatus");
                                                        statusEl.textContent = data.isBanned ? "Banned" : "Active";
                                                        statusEl.className = "badge " + (data.isBanned ? "badge-danger" : "badge-success");

                                                        const modal = new bootstrap.Modal(document.getElementById("userDetailModal"));
                                                        modal.show();
                                                        } catch (err) {
                                                        alert("Không thể tải thông tin người dùng.");
                                                        console.error(err);
                                                        }
                                                    });
                                                }); 
                                                
                                                headers.forEach(header => {
                                                    header.addEventListener("click", () => {
                                                    const columnIndex = parseInt(header.getAttribute("data-dt-column"));
                                                    const table = header.closest("table");
                                                    const tbody = table.querySelector("tbody");
                                                    const rows = Array.from(tbody.querySelectorAll("tr"));

                                                    // Toggle sort direction
                                                    const currentSort = header.getAttribute("data-sort") || "asc";
                                                    const nextSort = currentSort === "asc" ? "desc" : "asc";
                                                    headers.forEach(h => h.removeAttribute("data-sort"));
                                                    header.setAttribute("data-sort", nextSort);

                                                    // Helper: làm sạch số dư
                                                    const cleanNumber = (str) => parseFloat(str.replace(/[^\d.-]/g, '')) || 0;

                                                    rows.sort((a, b) => {
                                                        let aCell = a.children[columnIndex];
                                                        let bCell = b.children[columnIndex];

                                                        let aText = aCell?.innerText.trim() || "";
                                                        let bText = bCell?.innerText.trim() || "";

                                                        // Nếu cột là balance → parseFloat
                                                        if (header.innerText.includes("Balance")) {
                                                        aText = cleanNumber(aText);
                                                        bText = cleanNumber(bText);
                                                        }

                                                        // Nếu cột là status → chuyển về lowercase để sort chữ
                                                        if (header.innerText.includes("Status")) {
                                                        aText = aText.toLowerCase();
                                                        bText = bText.toLowerCase();
                                                        }

                                                        if (aText < bText) return nextSort === "asc" ? -1 : 1;
                                                        if (aText > bText) return nextSort === "asc" ? 1 : -1;
                                                        return 0;
                                                    });

                                                    rows.forEach(row => tbody.appendChild(row));
                                                    });
                                                });
                                            });   

                                        document.addEventListener("DOMContentLoaded", () => {
                                            const tableBody = document.querySelector("#kt_ecommerce_products_table tbody");
                                            const rows = Array.from(tableBody.querySelectorAll("tr"));
                                            const lengthSelect = document.getElementById("dt-length-0");
                                            const paginationContainer = document.querySelector(".pagination");

                                            let pageSize = parseInt(lengthSelect.value);
                                            let currentPage = 1;

                                            function renderPage(page) {
                                                currentPage = page;
                                                const start = (page - 1) * pageSize;
                                                const end = start + pageSize;

                                                rows.forEach((row, index) => {
                                                row.style.display = index >= start && index < end ? "" : "none";
                                                });

                                                renderPagination();
                                            }

                                            function renderPagination() {
                                                const totalPages = Math.ceil(rows.length / pageSize);
                                                paginationContainer.innerHTML = "";

                                                // Prev
                                                const prev = document.createElement("li");
                                                prev.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                                                prev.innerHTML = `<button class="page-link">«</button>`;
                                                prev.onclick = () => {
                                                if (currentPage > 1) renderPage(currentPage - 1);
                                                };
                                                paginationContainer.appendChild(prev);

                                                // Numbered buttons
                                                for (let i = 1; i <= totalPages; i++) {
                                                const li = document.createElement("li");
                                                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                                                li.innerHTML = `<button class="page-link">${i}</button>`;
                                                li.onclick = () => renderPage(i);
                                                paginationContainer.appendChild(li);
                                                }

                                                // Next
                                                const next = document.createElement("li");
                                                next.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                                                next.innerHTML = `<button class="page-link">»</button>`;
                                                next.onclick = () => {
                                                if (currentPage < totalPages) renderPage(currentPage + 1);
                                                };
                                                paginationContainer.appendChild(next);
                                            }

                                            // Khi đổi số lượng hiển thị
                                            lengthSelect.addEventListener("change", () => {
                                                pageSize = parseInt(lengthSelect.value);
                                                renderPage(1);
                                            });

                                            // Khởi động
                                            renderPage(1);
                                            });
                                            </script>

                                        
                                    </div>
                                    <!--end::Card body-->
                                 </div>
                                 <!--end::Products-->        
                              </div>
                              <!--end::Content container-->
                           </div>
                        </div>
                        <!--end::Content container-->
                     </div>
                     <!--end::Content-->
                  </div>
                  <!--end::Content wrapper-->
                  <!--begin::Footer-->
                  {{> footerAD }}
                  <!--end::Footer-->
               </div>
               <!--end:::Main-->
            </div>
            <!--end::Wrapper-->
         </div>
         <!--end::Page-->
      </div>
      <!--end::App--> 
      {{> scripts }}
   </body>
   <!--end::Body-->
</html>